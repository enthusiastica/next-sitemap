name: 1.0$(rev:.r)
trigger:
  branches:
    include:
      - master
      # - development
pr: none

pool:
  vmImage: 'ubuntu-latest'

steps:
  # Authenticate
  - task: npmAuthenticate@0
    displayName: NPM Auth
    inputs:
      workingFile: .npmrc
      customEndpoint: 'NPM(Vishnu Sankar)'

  # Build & Test
  - bash: |
      yarn install
      yarn lint
      yarn test
      yarn build:ywc
      yarn set-version
      cp README.md packages/next-sitemap/README.md
    displayName: Build & Test

  # Test Result
  - task: PublishTestResults@2
    displayName: Publish Test Result
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'junit.xml'
      failTaskOnFailedTests: true

  # Coverage Result
  - task: PublishCodeCoverageResults@1
    displayName: Publish Coverage Result
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'coverage/cobertura-coverage.xml'
      failIfCoverageEmpty: true

  # Publish Packages
  - bash: |
      yarn ywc publish
    displayName: Publish Packages

  # Github Release
  - task: GitHubRelease@1
    displayName: Github Release
    inputs:
      gitHubConnection: 'iamvishnusankar'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      tag: 'v$(Build.BuildNumber)'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
